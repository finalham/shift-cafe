<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ©ãƒ³ãƒŠãƒ¼ï¼ˆå®Ÿè¡Œãƒœã‚¿ãƒ³ä»˜ããƒ»å®‰å®šç‰ˆï¼‰</title>
  <style>
    :root{ --bg:#0f1216; --fg:#e6ebf3; --dim:#9aa3b2; --panel:#151a21; --line:#242a33; --acc:#31c48d; --err:#ef4444; }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--fg); font:14px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif; }
    header{ padding:12px 16px; border-bottom:1px solid var(--line); display:flex; gap:12px; align-items:center; }
    header h1{ margin:0; font-size:16px; font-weight:700; }
    .hint{ color:var(--dim); font-size:12px; }
    main{ height:calc(100vh - 54px); display:grid; grid-template-columns: 1fr 1fr; }
    .pane{ display:flex; flex-direction:column; min-width:0; }
    .toolbar{ padding:8px; background:var(--panel); border-bottom:1px solid var(--line); display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .toolbar button{ background:#1e252f; color:#fff; border:1px solid var(--line); padding:8px 12px; border-radius:8px; cursor:pointer; }
    .toolbar button.primary{ background:var(--acc); color:#08110c; border-color:transparent; font-weight:700; }
    .toolbar .right{ margin-left:auto; color:var(--dim); font-size:12px; }
    textarea{ flex:1; width:100%; border:0; outline:none; background:#0c1015; color:#c7d1e3; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; padding:12px; resize:none; }
    iframe{ flex:1; width:100%; border:0; background:#fff; }
    .errors{ padding:8px 12px; background:#1a1212; color:#ffd6d6; border-top:1px solid #3a2626; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap; }
    .errors.hidden{ display:none; }
  </style>
</head>
<body>
  <header>
    <h1>HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ©ãƒ³ãƒŠãƒ¼</h1>
    <div class="hint">å·¦ã«HTMLã‚’è²¼ã£ã¦ã€Œå®Ÿè¡Œã€â†’ å³ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€‚ä¿å­˜/èª­è¾¼/ã‚µãƒ³ãƒ—ãƒ«/ãƒ†ã‚¹ãƒˆã‚ã‚Šã€‚</div>
  </header>
  <main>
    <section class="pane">
      <div class="toolbar">
        <button id="run" class="primary">â–¶ å®Ÿè¡Œ</button>
        <button id="save">ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜</button>
        <button id="load">ğŸ“‚ èª­ã¿è¾¼ã¿</button>
        <button id="loadSample">â˜• ã‚µãƒ³ãƒ—ãƒ«ï¼ˆMscafe SHIFTï¼‰</button>
        <button id="test1">ğŸ§ª Test 1: Hello</button>
        <button id="test2">ğŸ§ª Test 2: Script</button>
        <button id="test3">ğŸ§ª Test 3: Mscafe</button>
        <span class="right">ä¿å­˜ã‚­ãƒ¼: <code>runner_html</code></span>
      </div>
      <textarea id="editor" spellcheck="false" placeholder="ã“ã“ã«HTMLã‚’æ›¸ã„ã¦ã€å®Ÿè¡Œã€ã§å³ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
      <div id="errorBox" class="errors hidden" role="alert" aria-live="polite"></div>
    </section>
    <section class="pane">
      <div class="toolbar"><strong>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</strong></div>
      <iframe id="preview" title="preview"></iframe>
    </section>
  </main>

  <!-- ã‚µãƒ³ãƒ—ãƒ«ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ ¼ç´ã—ã¦å®‰å…¨ã«å–ã‚Šå‡ºã™ï¼‰ -->
  <template id="sampleCafe">
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mscafe SHIFTï¼ˆCafe Style HTML MVPï¼‰</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{ --coffee:#6b4f4f; --latte:#f7efe5; --cream:#fffaf3; --cocoa:#a37a74; --sage:#3e7a6b; --line:#e9ddd3; --ink:#2a2a2a; --muted:#7a6f69; --shadow: 0 10px 30px rgba(107,79,79,.15); }
    html,body{ height:100%; }
    body{ margin:0; color:var(--ink); font-family: 'Montserrat', 'Noto Sans JP', system-ui, -apple-system, Segoe UI, Roboto, Meiryo, sans-serif; background: radial-gradient(1200px 800px at 10% -10%, rgba(255,255,255,.8), transparent 60%), radial-gradient(900px 600px at 110% 0%, rgba(247,239,229,.9), transparent 50%), linear-gradient(180deg, #fff, var(--latte)); }
    header{ position: sticky; top:0; z-index:10; background: linear-gradient(180deg, var(--cream), rgba(255,255,255,0.85)); backdrop-filter: blur(6px); border-bottom:1px solid var(--line); padding:12px 18px; display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{ width:34px; height:34px; border-radius:50%; background: conic-gradient(from 200deg, var(--coffee), var(--cocoa)); color:#fff; display:grid; place-items:center; box-shadow: var(--shadow); }
    .name{ font-family:'Pacifico', cursive; font-size:22px; color:var(--coffee); letter-spacing:.5px; }
    nav a{ text-decoration:none; color:var(--muted); padding:8px 12px; border-radius:999px; border:1px solid transparent; transition:.2s ease; }
    nav a:hover{ background:#fff; border-color: var(--line); color:var(--coffee); }
    nav a.active{ background: var(--sage); color:#fff; border-color: transparent; }
    main{ max-width: 1064px; margin: 0 auto; padding: 20px; }
    section{ display:none; } section.active{ display:block; }
    .card{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:16px 16px 18px; box-shadow: var(--shadow); margin: 18px 0; }
    .card h2, .card h3{ margin:.2rem 0 .8rem; color: var(--coffee); }
    .row{ display:flex; gap:14px; flex-wrap:wrap; } .col{ flex:1 1 260px; min-width:240px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input, select, button{ width:100%; box-sizing:border-box; padding:12px; border:1px solid var(--line); border-radius:12px; font-size:14px; background:#fff; color:var(--ink); }
    input:focus, select:focus{ outline:2px solid rgba(62,122,107,.15); border-color: var(--sage); }
    .btn{ display:inline-flex; gap:8px; align-items:center; justify-content:center; cursor:pointer; font-weight:600; }
    .btn.primary{ background: var(--sage); color:#fff; border: none; box-shadow: 0 6px 18px rgba(62,122,107,.25); }
    .btn.ghost{ background:#fff; color:var(--coffee); border:1px solid var(--line); }
    .btn.warn{ background:#fff5f5; color:#8b2c2c; border:1px solid #f1c9c9; }
    .btn:hover{ transform: translateY(-1px); }
    table{ width:100%; border-collapse:collapse; background:#fff; }
    th, td{ border:1px solid var(--line); padding:9px 10px; font-size:13px; }
    thead th{ background: linear-gradient(180deg, #fff, #faf7f3); color: var(--coffee); position:sticky; top:0; z-index:1; }
    tbody tr:nth-child(odd){ background: #fffdf9; } .right{ text-align:right; } .muted{ color:var(--muted); }
    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; background:#f0faf7; color:var(--sage); font-size:12px; border:1px solid #d8eee6; }
    .report{ border:1px dashed var(--line); background:#fff; border-radius:14px; padding:12px 12px 14px; }
    .report h2{ font-size:18px; font-weight:700; color:var(--coffee); }
    @media print{ header, #nav, .no-print{ display:none !important; } body{ background:#fff; } .report{ border:1px solid #000; padding:8px; box-shadow:none; } .report table{ border-collapse:collapse; width:100%; font-size:11px; } .report th, .report td{ border:1px solid #000; padding:4px; } .report thead th{ background:#eee !important; } }
    .divider{ height:10px; background: repeating-linear-gradient(45deg, #f2e7db 0 10px, #f6efe6 10px 20px); border-radius:10px; margin:8px 0 16px; }
    .tag{ display:inline-block; padding:2px 6px; border-radius:6px; font-size:11px; border:1px solid #eee; color:#8a6c6c; background:#fff7f2; }
  </style>
</head>
<body>
  <header>
    <div class="brand"><div class="logo">â˜•</div><div class="name">Mscafe SHIFT</div></div>
    <nav id="nav"><a href="#checkin" id="lnk-checkin">æ‰“åˆ»ãƒ•ã‚©ãƒ¼ãƒ </a><a href="#admin" id="lnk-admin">ç®¡ç†ï¼ˆé›†è¨ˆ/ãƒ¬ãƒãƒ¼ãƒˆ/å¾“æ¥­å“¡ï¼‰</a><a href="#settings" id="lnk-settings">çµ¦ä¸ãƒ«ãƒ¼ãƒ«</a></nav>
    <span class="badge" id="siteLabel"></span>
  </header>
  <main>
    <!-- æ‰“åˆ»ãƒ•ã‚©ãƒ¼ãƒ  -->
    <section id="checkin" class="active"><div class="card"><h2>æ‰“åˆ»ãƒ•ã‚©ãƒ¼ãƒ </h2><div class="divider"></div>
      <div class="row"><div class="col"><label>å¾“æ¥­å“¡</label><select id="empSelect"></select></div>
      <div class="col"><label>é–‹å§‹ï¼ˆæ—¥æ™‚ï¼‰</label><input type="datetime-local" id="startAt" /></div>
      <div class="col"><label>ä¼‘æ†©ï¼ˆåˆ†ï¼‰</label><input type="number" id="breakMin" value="0" min="0" step="5" /></div>
      <div class="col"><label>çµ‚äº†ï¼ˆæ—¥æ™‚ï¼‰</label><input type="datetime-local" id="endAt" /></div></div>
      <div class="row" style="margin-top:10px;"><div class="col"><button class="btn primary" id="btnSave">ğŸ’¾ ä¿å­˜</button></div><div class="col"><button class="btn ghost" id="btnNow">ğŸ•’ ç¾åœ¨æ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆ</button></div></div>
      <div id="saveMsg" class="muted" style="margin-top:10px;"></div></div>
      <div class="card"><h3>æœ€è¿‘ã®å…¥åŠ›</h3><table id="recentTable"></table></div>
    </section>

    <!-- ç®¡ç†ï¼ˆé›†è¨ˆ/ãƒ¬ãƒãƒ¼ãƒˆ/å¾“æ¥­å“¡ç®¡ç†ï¼‰ -->
    <section id="admin">
      <div class="card"><h2>æœˆæ¬¡é›†è¨ˆ</h2><div class="divider"></div>
        <div class="row"><div class="col"><label>å¯¾è±¡æœˆ</label><input type="month" id="adminMonth" /></div>
        <div class="col"><label>&nbsp;</label><button class="btn primary" id="btnRefresh">ğŸ”„ å†è¨ˆç®—</button></div></div>
        <table id="summaryTable" style="margin-top:12px;"></table>
      </div>

      <div class="card"><h3>å¾“æ¥­å“¡ç®¡ç†ï¼ˆæœ‰åŠ¹/ç„¡åŠ¹ï¼‰</h3>
        <div class="row">
          <div class="col"><label>æ°å</label><input id="empName" /></div>
          <div class="col"><label>ç¤¾å“¡ç•ªå·</label><input id="empCode" /></div>
          <div class="col"><label>æ™‚çµ¦</label><input id="empWage" type="number" /></div>
          <div class="col"><label>&nbsp;</label><button id="btnAddEmp" class="btn primary">è¿½åŠ </button></div>
        </div>
        <table id="empTable" style="margin-top:12px;"></table>
      </div>

      <div class="card"><h3>å¾“æ¥­å“¡åˆ¥ãƒ¬ãƒãƒ¼ãƒˆï¼ˆExcelé¢¨PDFï¼‰</h3>
        <div class="row"><div class="col"><label>å¾“æ¥­å“¡</label><select id="reportEmp"></select></div>
        <div class="col"><label>å¯¾è±¡æœˆ</label><input type="month" id="reportMonth" /></div>
        <div class="col"><label>&nbsp;</label><button class="btn primary no-print" id="btnRenderReport">ğŸ§¾ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button></div>
        <div class="col"><label>&nbsp;</label><button class="btn ghost no-print" id="btnPrint">ğŸ–¨ PDFã«å°åˆ·</button></div></div>
        <div id="reportArea" class="report" style="margin-top:12px;"></div>
      </div>
    </section>

    <!-- çµ¦ä¸ãƒ«ãƒ¼ãƒ«è¨­å®š -->
    <section id="settings"><div class="card"><h2>çµ¦ä¸ãƒ«ãƒ¼ãƒ«</h2><div class="divider"></div>
      <div class="row"><div class="col"><label>é–‹å§‹ä¸¸ã‚ï¼ˆåˆ†ï¼‰</label><select id="roundStart"><option>1</option><option selected>5</option><option>10</option><option>15</option><option>30</option></select></div>
      <div class="col"><label>çµ‚äº†ä¸¸ã‚ï¼ˆåˆ†ï¼‰</label><select id="roundEnd"><option>1</option><option selected>5</option><option>10</option><option>15</option><option>30</option></select></div>
      <div class="col"><label>å®Ÿåƒä¸¸ã‚ï¼ˆåˆ†ï¼‰</label><select id="roundWorked"><option selected>1</option><option>5</option><option>10</option><option>15</option><option>30</option></select></div>
      <div class="col"><label>ä¸¸ã‚æ–¹å¼</label><select id="roundMode"><option value="floor" selected>åˆ‡æ¨ã¦</option><option value="round">å››æ¨äº”å…¥</option><option value="ceil">åˆ‡ä¸Šã’</option></select></div></div>
      <div class="row" style="margin-top:8px;"><div class="col"><label>æ™‚çµ¦ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</label><input type="number" id="defaultWage" value="1100" /></div>
      <div class="col"><label>äº¤é€šè²»ï¼ˆæœˆé¡ãƒ»å®šé¡ï¼‰</label><input type="number" id="commuteFixed" value="0" /></div>
      <div class="col"><label>&nbsp;</label><button class="btn primary" id="btnSaveRules">ğŸ’¾ ãƒ«ãƒ¼ãƒ«ã‚’ä¿å­˜</button></div></div>
    </div></section>
  </main>

  <script>
    // ä¾å­˜ã®ãªã„ç´ ã®JSã®ã¿ã€‚$ ãªã©ã®åˆ¥åã¯ä½¿ç”¨ã—ãªã„
    function pad(n){ return String(n).padStart(2,'0') }
    function ymd(d){ return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate()) }
    function hm(d){ return pad(d.getHours())+":"+pad(d.getMinutes()) }
    function getQuery(){ return new URLSearchParams(location.search) }
    function getSite(){ return getQuery().get('site') || 'HQ' }
    function load(key, def){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)) }catch(e){ return def } }
    function save(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
    function roundUnit(min, unit, mode){ var q=min/unit; if(mode==='ceil') return Math.ceil(q)*unit; if(mode==='floor') return Math.floor(q)*unit; return Math.round(q)*unit }
    function minutesBetween(start, end){ var s=new Date(start), e=new Date(end); var e2 = e<s ? new Date(e.getTime()+86400000) : e; return Math.max(0, Math.round((e2 - s)/60000)) }

    var STATE = {
      employees: load('employees', [
        {id: (crypto.randomUUID?crypto.randomUUID():String(Math.random())), code:'A001', name:'å±±ç”°å¤ªéƒ', hourly_wage:1150, active:true},
        {id: (crypto.randomUUID?crypto.randomUUID():String(Math.random())), code:'A002', name:'ä½è—¤èŠ±å­', hourly_wage:1200, active:true}
      ]),
      shifts: load('shifts', []),
      rules: load('rules', { roundStart:5, roundEnd:5, roundWorked:1, roundMode:'floor', defaultWage:1100, commuteFixed:0 })
    }

    function persist(){ save('employees', STATE.employees); save('shifts', STATE.shifts); save('rules', STATE.rules) }
    function route(){
      var hash = location.hash || '#checkin'
      Array.from(document.querySelectorAll('nav a')).forEach(function(a){ a.classList.toggle('active', a.getAttribute('href')===hash) })
      Array.from(document.querySelectorAll('main section')).forEach(function(sec){ sec.classList.toggle('active', '#'+sec.id===hash) })
    }
    window.addEventListener('hashchange', route)

    function init(){
      document.getElementById('siteLabel').textContent = 'æ‹ ç‚¹: '+getSite()

      // æ‰“åˆ»ãƒ•ã‚©ãƒ¼ãƒ 
      renderEmpSelect(); setNow(); document.getElementById('btnNow').onclick=setNow; document.getElementById('btnSave').onclick=onSaveShift; renderRecent()

      // ç®¡ç†
      var now = new Date(); document.getElementById('adminMonth').value = now.getFullYear()+"-"+pad(now.getMonth()+1)
      document.getElementById('btnRefresh').onclick = renderSummary; renderSummary()

      // å¾“æ¥­å“¡ç®¡ç†ï¼ˆadminã«ç§»è¨­ï¼‰
      document.getElementById('btnAddEmp').onclick = addEmployee
      renderEmpTable()

      // ãƒ¬ãƒãƒ¼ãƒˆ
      renderReportEmp(); document.getElementById('reportMonth').value = now.getFullYear()+"-"+pad(now.getMonth()+1)
      document.getElementById('btnRenderReport').onclick = renderReport; document.getElementById('btnPrint').onclick = function(){ window.print() }

      // ãƒ«ãƒ¼ãƒ«
      document.getElementById('roundStart').value = STATE.rules.roundStart
      document.getElementById('roundEnd').value = STATE.rules.roundEnd
      document.getElementById('roundWorked').value = STATE.rules.roundWorked
      document.getElementById('roundMode').value = STATE.rules.roundMode
      document.getElementById('defaultWage').value = STATE.rules.defaultWage
      document.getElementById('commuteFixed').value = STATE.rules.commuteFixed
      document.getElementById('btnSaveRules').onclick = function(){
        STATE.rules.roundStart = parseInt(document.getElementById('roundStart').value)
        STATE.rules.roundEnd = parseInt(document.getElementById('roundEnd').value)
        STATE.rules.roundWorked = parseInt(document.getElementById('roundWorked').value)
        STATE.rules.roundMode = document.getElementById('roundMode').value
        STATE.rules.defaultWage = parseFloat(document.getElementById('defaultWage').value||0)
        STATE.rules.commuteFixed = parseFloat(document.getElementById('commuteFixed').value||0)
        persist(); alert('ä¿å­˜ã—ã¾ã—ãŸ')
      }

      route()
    }

    // ------- å¾“æ¥­å“¡ -------
    function renderEmpSelect(){
      var sel = document.getElementById('empSelect'); sel.innerHTML = ''
      STATE.employees.filter(function(e){ return e.active }).forEach(function(e){
        var opt = document.createElement('option'); opt.value = e.id; opt.textContent = e.name+'ï¼ˆ'+(e.code||'')+'ï¼‰'
        sel.appendChild(opt)
      })
    }
    function renderReportEmp(){
      var sel = document.getElementById('reportEmp'); sel.innerHTML = ''
      STATE.employees.forEach(function(e){
        var opt = document.createElement('option'); opt.value = e.id; opt.textContent = e.name + (e.active? '' : 'ï¼ˆç„¡åŠ¹ï¼‰')
        sel.appendChild(opt)
      })
    }
    function addEmployee(){
      var name = document.getElementById('empName').value.trim();
      var code = document.getElementById('empCode').value.trim();
      var wage = parseFloat(document.getElementById('empWage').value || STATE.rules.defaultWage)
      if(!name){ alert('æ°åã‚’å…¥åŠ›'); return }
      var id = (crypto.randomUUID?crypto.randomUUID():String(Math.random()))
      STATE.employees.push({ id:id, code:code, name:name, hourly_wage:wage, active:true })
      persist(); renderEmpSelect(); renderReportEmp(); renderEmpTable()
      document.getElementById('empName').value = ''; document.getElementById('empCode').value=''; document.getElementById('empWage').value=''
    }
    function toggleActive(index){
      var e = STATE.employees[index]; if(!e) return
      var msg = e.active? 'ã“ã®å¾“æ¥­å“¡ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ' : 'ã“ã®å¾“æ¥­å“¡ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ'
      if(!confirm(msg)) return
      e.active = !e.active
      persist(); renderEmpTable(); renderEmpSelect(); renderReportEmp(); renderSummary()
    }
    function renderEmpTable(){
      var t = document.getElementById('empTable')
      t.innerHTML = '<thead><tr><th>çŠ¶æ…‹</th><th>æ°å</th><th>ç¤¾å“¡ç•ªå·</th><th class="right">æ™‚çµ¦</th><th>æ“ä½œ</th></tr></thead>'
      var tb = document.createElement('tbody')
      STATE.employees.forEach(function(e,i){
        var tr = document.createElement('tr')
        var wageDisp = (e.hourly_wage && e.hourly_wage.toLocaleString? e.hourly_wage.toLocaleString() : STATE.rules.defaultWage)
        tr.innerHTML = '<td>'+(e.active? '<span class="tag">æœ‰åŠ¹</span>' : '<span class="tag">ç„¡åŠ¹</span>')+'</td>'+
                       '<td>'+e.name+(e.active? '' : 'ï¼ˆç„¡åŠ¹ï¼‰')+'</td>'+
                       '<td>'+(e.code||'')+'</td>'+
                       '<td class="right">'+wageDisp+'</td>'+
                       '<td>'+(e.active? '<button class="btn warn" data-i="'+i+'">ç„¡åŠ¹åŒ–</button>' : '<button class="btn ghost" data-i="'+i+'">æœ‰åŠ¹åŒ–</button>')+'</td>'
        tb.appendChild(tr)
      })
      t.appendChild(tb)
      Array.from(tb.querySelectorAll('button')).forEach(function(btn){ btn.onclick = function(){ toggleActive(parseInt(btn.getAttribute('data-i'))) } })
    }

    // ------- æ‰“åˆ»ä¿å­˜ -------
    function setNow(){
      var now = new Date(); var iso = now.getFullYear()+"-"+pad(now.getMonth()+1)+"-"+pad(now.getDate())+"T"+pad(now.getHours())+":"+pad(now.getMinutes())
      document.getElementById('startAt').value = iso; document.getElementById('endAt').value = iso
    }

    function onSaveShift(){
      var employee_id = document.getElementById('empSelect').value
      if(!employee_id){ alert('å¾“æ¥­å“¡ã‚’é¸æŠ'); return }
      var emp = STATE.employees.find(function(e){ return e.id===employee_id })
      if(!emp || !emp.active){ alert('ç„¡åŠ¹åŒ–ã•ã‚ŒãŸå¾“æ¥­å“¡ã¯æ‰“åˆ»ã§ãã¾ã›ã‚“'); return }

      var start = document.getElementById('startAt').value; var end = document.getElementById('endAt').value
      var breakMin = parseInt(document.getElementById('breakMin').value || '0')
      if(!start || !end){ alert('é–‹å§‹ã¨çµ‚äº†ã‚’å…¥åŠ›'); return }

      var sMinRaw = Math.floor(new Date(start).getTime()/60000)
      var eMinRaw = Math.floor(new Date(end).getTime()/60000)
      var sMin = roundUnit(sMinRaw, STATE.rules.roundStart, STATE.rules.roundMode)
      var eMin = roundUnit(eMinRaw, STATE.rules.roundEnd, STATE.rules.roundMode)
      var startR = new Date(sMin*60000).toISOString()
      var endR = new Date(eMin*60000).toISOString()

      var worked = Math.max(0, roundUnit(minutesBetween(startR, endR) - breakMin, STATE.rules.roundWorked, STATE.rules.roundMode))
      var site = getSite()
      var date = ymd(new Date(startR))
      STATE.shifts.push({ id: (crypto.randomUUID?crypto.randomUUID():String(Math.random())), employee_id:employee_id, site:site, date:date, start:startR, end:endR, break_min:breakMin, worked_min:worked })
      persist()

      var wage = (emp.hourly_wage!=null ? emp.hourly_wage : STATE.rules.defaultWage)
      var pay = Math.round(wage * (worked/60))
      document.getElementById('saveMsg').textContent = 'ä¿å­˜ã—ã¾ã—ãŸã€‚å®Ÿåƒ '+(worked/60).toFixed(2)+' hã€æ¦‚ç®—æ—¥çµ¦ '+pay.toLocaleString()+' å††'
      renderRecent(); renderSummary()
    }

    // ------- ç”»é¢ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° -------
    function renderRecent(){
      var t = document.getElementById('recentTable')
      var items = STATE.shifts.slice(-10).reverse()
      t.innerHTML = '<thead><tr><th>æ°å</th><th>æ—¥ä»˜</th><th>å‡ºå‹¤</th><th>é€€å‹¤</th><th class="right">ä¼‘æ†©(åˆ†)</th><th class="right">å®Ÿåƒ(h)</th><th>æ‹ ç‚¹</th></tr></thead>'
      var tb = document.createElement('tbody')
      items.forEach(function(s){
        var emp = STATE.employees.find(function(e){ return e.id===s.employee_id })
        var st = new Date(s.start), ed = new Date(s.end)
        var tr = document.createElement('tr')
        tr.innerHTML = '<td>'+(emp?emp.name:'')+(emp && !emp.active?'ï¼ˆç„¡åŠ¹ï¼‰':'')+'</td><td>'+s.date+'</td><td>'+hm(st)+'</td><td>'+hm(ed)+'</td><td class="right">'+s.break_min+'</td><td class="right">'+(s.worked_min/60).toFixed(2)+'</td><td>'+s.site+'</td>'
        tb.appendChild(tr)
      })
      t.appendChild(tb)
    }

    function renderSummary(){
      var month = document.getElementById('adminMonth').value
      var t = document.getElementById('summaryTable')
      t.innerHTML = '<thead><tr><th>æ°å</th><th class="right">å‹¤å‹™æ—¥æ•°</th><th class="right">ç·æ™‚é–“(h)</th><th class="right">æ™‚çµ¦(å††)</th><th class="right">äº¤é€šè²»(å›ºå®š)</th><th class="right">ç·æ”¯çµ¦(æ¦‚ç®—)</th></tr></thead>'
      var tb = document.createElement('tbody')

      var byEmp = {}
      STATE.shifts.forEach(function(s){
        if(!s.date || s.date.indexOf(month)!==0) return
        if(!byEmp[s.employee_id]) byEmp[s.employee_id] = { days:0, min:0 }
        byEmp[s.employee_id].days += 1
        byEmp[s.employee_id].min += (s.worked_min || (minutesBetween(s.start, s.end) - (s.break_min||0)))
      })

      STATE.employees.forEach(function(e){
        var r = byEmp[e.id] || { days:0, min:0 }
        var hours = r.min/60
        var wage = (e.hourly_wage!=null ? e.hourly_wage : STATE.rules.defaultWage)
        var base = Math.round(hours * wage)
        var total = base + (STATE.rules.commuteFixed||0)
        var nameDisp = e.name + (e.active? '' : 'ï¼ˆç„¡åŠ¹ï¼‰')
        var tr = document.createElement('tr')
        tr.innerHTML = '<td>'+nameDisp+'</td><td class="right">'+r.days+'</td><td class="right">'+hours.toFixed(2)+'</td><td class="right">'+wage.toLocaleString()+'</td><td class="right">'+(STATE.rules.commuteFixed||0).toLocaleString()+'</td><td class="right">'+total.toLocaleString()+'</td>'
        tb.appendChild(tr)
      })
      t.appendChild(tb)
    }

    function renderReport(){
      var empId = document.getElementById('reportEmp').value
      var month = document.getElementById('reportMonth').value
      var emp = STATE.employees.find(function(e){ return e.id===empId })
      if(!emp){ alert('å¾“æ¥­å“¡ã‚’é¸æŠ'); return }
      var wage = (emp.hourly_wage!=null ? emp.hourly_wage : STATE.rules.defaultWage)

      var list = STATE.shifts.filter(function(s){ return s.employee_id===empId && s.date && s.date.indexOf(month)===0 })
      list.sort(function(a,b){ return a.date.localeCompare(b.date) })

      var rows = ''
      var totalMin = 0
      list.forEach(function(s){
        var st = new Date(s.start), ed = new Date(s.end)
        var worked = (s.worked_min!=null ? s.worked_min : (minutesBetween(s.start, s.end) - (s.break_min||0)))
        totalMin += worked
        var daily = Math.round(wage * (worked/60))
        rows += '<tr>'+
          '<td>'+s.date+'</td>'+
          '<td>'+hm(st)+'</td>'+
          '<td>'+hm(ed)+'</td>'+
          '<td class="right">'+(s.break_min||0)+'</td>'+
          '<td class="right">'+(worked/60).toFixed(2)+'</td>'+
          '<td class="right">'+wage.toLocaleString()+'</td>'+
          '<td class="right">'+daily.toLocaleString()+'</td>'+
        '</tr>'
      })
      var totalH = (totalMin/60).toFixed(2)
      var totalPay = Math.round((totalMin/60)*wage + (STATE.rules.commuteFixed||0))

      document.getElementById('reportArea').innerHTML =
        '<h2>ã‚¢ãƒ«ãƒã‚¤ãƒˆçµ¦ä¸è¨ˆç®—è¡¨ï¼ˆ'+month+'ï¼‰</h2>'+
        '<table style="margin-bottom:6px;border:none;">'+
          '<tr style="border:none;"><td style="border:none;">æ°åï¼š</td><td style="border:none;">'+emp.name+(emp.active?'':'ï¼ˆç„¡åŠ¹ï¼‰')+'</td></tr>'+
          '<tr style="border:none;"><td style="border:none;">æ™‚çµ¦ï¼š</td><td style="border:none;">'+wage.toLocaleString()+' å††</td></tr>'+
          '<tr style="border:none;"><td style="border:none;">äº¤é€šè²»ï¼ˆæœˆé¡ãƒ»å®šé¡ï¼‰ï¼š</td><td style="border:none;">'+(STATE.rules.commuteFixed||0).toLocaleString()+' å††</td></tr>'+
        '</table>'+
        '<table>'+
          '<thead><tr><th>æ—¥ä»˜</th><th>å‡ºå‹¤æ™‚é–“</th><th>é€€å‹¤æ™‚é–“</th><th>ä¼‘æ†©(åˆ†)</th><th>å®Ÿåƒ(h)</th><th>æ™‚çµ¦</th><th>æ—¥çµ¦é¡</th></tr></thead>'+
          '<tbody>'+ (rows || '<tr><td colspan="7">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>') +'</tbody>'+
        '</table>'+
        '<table style="margin-top:6px;border:none;">'+
          '<tr style="border:none;"><td style="border:none;">ç·å‹¤å‹™æ™‚é–“ï¼š</td><td style="border:none;">'+totalH+' h</td></tr>'+
          '<tr style="border:none;"><td style="border:none;">ç·æ”¯çµ¦é¡ï¼ˆæ¦‚ç®—ï¼‰ï¼š</td><td style="border:none;">'+totalPay.toLocaleString()+' å††</td></tr>'+
        '</table>'
    }

    // èµ·å‹•
    init()
  </script>
</body>
</html>
  </template>

  <script>
    // è¦ç´ å‚ç…§ï¼ˆjQueryé¢¨ã‚·ãƒ§ãƒ¼ãƒˆãƒãƒ³ãƒ‰ã¯ä½¿ã‚ãªã„ï¼‰
    var editor = document.getElementById('editor')
    var frame = document.getElementById('preview')
    var errorBox = document.getElementById('errorBox')

    // Local storage helpers
    var KEY = 'runner_html'
    function saveLocal(){ localStorage.setItem(KEY, editor.value) }
    function loadLocal(){ editor.value = localStorage.getItem(KEY)||'' }

    function showError(msg){
      errorBox.textContent = msg
      errorBox.classList.remove('hidden')
    }
    function clearError(){
      errorBox.textContent = ''
      errorBox.classList.add('hidden')
    }

    // Run the code into iframe (with basic error handling)
    function run(){
      clearError()
      try{
        var doc = frame.contentWindow.document
        doc.open()
        doc.write(editor.value)
        doc.close()
      }catch(e){
        showError('å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼: '+ (e && e.message ? e.message : e))
      }
    }

    // Load sample (from <template>)
    function loadSample(){
      var tpl = document.getElementById('sampleCafe')
      if(!tpl){ showError('ã‚µãƒ³ãƒ—ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return }
      editor.value = tpl.innerHTML.trim()
    }

    // Minimal test cases
    function loadTest1(){ editor.value = '<!doctype html><title>Test1</title><h1>Hello</h1><p>Basic HTML should render.</p>' }
    function loadTest2(){ editor.value = '<!doctype html><title>Test2</title><script>document.addEventListener("DOMContentLoaded",()=>{document.body.innerHTML+="<p>Script OK</p>"})<\/script>' }
    function loadTest3(){ loadSample() }

    // Hook up UI
    document.getElementById('run').onclick = run
    document.getElementById('save').onclick = saveLocal
    document.getElementById('load').onclick = loadLocal
    document.getElementById('loadSample').onclick = function(){ loadSample(); run() }
    document.getElementById('test1').onclick = function(){ loadTest1(); run() }
    document.getElementById('test2').onclick = function(){ loadTest2(); run() }
    document.getElementById('test3').onclick = function(){ loadTest3(); run() }

    // Load last session automatically & run
    loadLocal()
    if(editor.value.trim()!=='') run()
  </script>
</body>
</html>
